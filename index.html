<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2048ゲーム</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #faf8ef;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 20px;
  }
  h1 {
    margin-bottom: 10px;
  }
  #game-container {
    background: #bbada0;
    padding: 15px;
    border-radius: 6px;
    position: relative;
  }
  #grid-container {
    width: 400px;
    height: 400px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-gap: 10px;
    background: #cdc1b4;
    border-radius: 6px;
    padding: 10px;
  }
  .tile {
    width: 90px;
    height: 90px;
    background: #eee4da;
    border-radius: 3px;
    font-size: 45px;
    font-weight: bold;
    text-align: center;
    line-height: 90px;
    user-select: none;
    transition: background 0.2s ease;
  }
  .tile-2    { background: #eee4da; color: #776e65; }
  .tile-4    { background: #ede0c8; color: #776e65; }
  .tile-8    { background: #f2b179; color: #f9f6f2; }
  .tile-16   { background: #f59563; color: #f9f6f2; }
  .tile-32   { background: #f67c5f; color: #f9f6f2; }
  .tile-64   { background: #f65e3b; color: #f9f6f2; }
  .tile-128  { background: #edcf72; color: #f9f6f2; font-size: 35px; }
  .tile-256  { background: #edcc61; color: #f9f6f2; font-size: 35px; }
  .tile-512  { background: #edc850; color: #f9f6f2; font-size: 35px; }
  .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 25px; }
  .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 25px; }
  #score-container {
    margin-bottom: 10px;
    font-size: 20px;
  }
  #message {
    margin-top: 15px;
    font-size: 24px;
    color: #776e65;
    font-weight: bold;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 18px;
    border: none;
    background-color: #8f7a66;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background-color: #9e8b7c;
  }
</style>
</head>
<body>
  <h1>2048ゲーム</h1>
  <div id="game-container">
    <div id="score-container">Score: <span id="score">0</span></div>
    <div id="grid-container"></div>
    <div id="message"></div>
  </div>
  <button id="restart-btn">リスタート</button>

<script>
  const SIZE = 4;
  let board = [];
  let score = 0;
  let hasWon = false;

  const gridContainer = document.getElementById('grid-container');
  const scoreContainer = document.getElementById('score');
  const messageContainer = document.getElementById('message');
  const restartBtn = document.getElementById('restart-btn');

  function init() {
    board = Array.from({ length: SIZE }, () => Array(SIZE).fill(0));
    score = 0;
    hasWon = false;
    messageContainer.textContent = '';
    scoreContainer.textContent = score;
    addRandomTile();
    addRandomTile();
    render();
  }

  function addRandomTile() {
    const emptyPositions = [];
    for (let r = 0; r < SIZE; r++) {
      for (let c = 0; c < SIZE; c++) {
        if (board[r][c] === 0) emptyPositions.push([r, c]);
      }
    }
    if (emptyPositions.length === 0) return false;

    const [r, c] = emptyPositions[Math.floor(Math.random() * emptyPositions.length)];
    board[r][c] = Math.random() < 0.9 ? 2 : 4;
    return true;
  }

  function render() {
    gridContainer.innerHTML = '';
    for (let r = 0; r < SIZE; r++) {
      for (let c = 0; c < SIZE; c++) {
        const tileValue = board[r][c];
        const tile = document.createElement('div');
        tile.classList.add('tile');
        if (tileValue > 0) {
          tile.classList.add('tile-' + tileValue);
          tile.textContent = tileValue;
        }
        gridContainer.appendChild(tile);
      }
    }
    scoreContainer.textContent = score;
  }

  function slideAndMerge(row) {
    let filtered = row.filter((v) => v !== 0);
    let merged = [];
    let skip = false;

    for (let i = 0; i < filtered.length; i++) {
      if (skip) {
        skip = false;
        continue;
      }
      if (i + 1 < filtered.length && filtered[i] === filtered[i + 1]) {
        merged.push(filtered[i] * 2);
        score += filtered[i] * 2;
        if (filtered[i] * 2 === 2048) hasWon = true;
        skip = true;
      } else {
        merged.push(filtered[i]);
      }
    }
    while (merged.length < SIZE) merged.push(0);
    return merged;
  }

  function move(direction) {
    if (hasWon) return;
    let moved = false;
    switch (direction) {
      case 'left':
        for (let r = 0; r < SIZE; r++) {
          const newRow = slideAndMerge(board[r]);
          if (!arraysEqual(board[r], newRow)) {
            board[r] = newRow;
            moved = true;
          }
        }
        break;
      case 'right':
        for (let r = 0; r < SIZE; r++) {
          const reversed = [...board[r]].reverse();
          const newRow = slideAndMerge(reversed).reverse();
          if (!arraysEqual(board[r], newRow)) {
            board[r] = newRow;
            moved = true;
          }
        }
        break;
      case 'up':
        for (let c = 0; c < SIZE; c++) {
          let col = [];
          for (let r = 0; r < SIZE; r++) col.push(board[r][c]);
          const newCol = slideAndMerge(col);
          for (let r = 0; r < SIZE; r++) {
            if (board[r][c] !== newCol[r]) {
              board[r][c] = newCol[r];
              moved = true;
            }
          }
        }
        break;
      case 'down':
        for (let c = 0; c < SIZE; c++) {
          let col = [];
          for (let r = 0; r < SIZE; r++) col.push(board[r][c]);
          const reversed = [...col].reverse();
          const newCol = slideAndMerge(reversed).reverse();
          for (let r = 0; r < SIZE; r++) {
            if (board[r][c] !== newCol[r]) {
              board[r][c] = newCol[r];
              moved = true;
            }
          }
        }
        break;
    }

    if (moved) {
      addRandomTile();
      render();
      if (hasWon) {
        messageContainer.textContent = 'おめでとう！2048達成！🎉';
      } else if (isGameOver()) {
        messageContainer.textContent = 'ゲームオーバー';
      }
    }
  }

  function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    return a.every((v, i) => v === b[i]);
  }

  function isGameOver() {
    for (let r = 0; r < SIZE; r++) {
      for (let c = 0; c < SIZE; c++) {
        if (board[r][c] === 0) return false;
        if (c < SIZE - 1 && board[r][c] === board[r][c + 1]) return false;
        if (r < SIZE - 1 && board[r][c] === board[r + 1][c]) return false;
      }
    }
    return true;
  }

  window.addEventListener('keydown', (e) => {
    switch (e.key) {
      case 'ArrowLeft':
        move('left');
        break;
      case 'ArrowRight':
        move('right');
        break;
      case 'ArrowUp':
        move('up');
        break;
      case 'ArrowDown':
        move('down');
        break;
    }
  });

  restartBtn.addEventListener('click', () => {
    init();
  });

  init();
</script>
</body>
</html>
